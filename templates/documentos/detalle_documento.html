{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ documento.tipo_documento }} #{{ documento.folio }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-file-earmark-text"></i> {{ documento.tipo_documento }} #{{ documento.folio }}</h2>
    <div>
      <a href="{% url 'listar_pedidos' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver a Pedidos
      </a>
      <button onclick="window.print()" class="btn btn-success">
        <i class="bi bi-printer"></i> Imprimir
      </button>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <!-- Datos del Cliente (Receptor) - usando campos EXISTENTES -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-person-badge"></i> Cliente (Receptor)
        </div>
        <div class="card-body">
          <p class="mb-1"><strong>{{ documento.razon_social|default:documento.cliente.razon_social }}</strong></p>
          <p class="mb-1">RUT: <strong>{{ documento.rut|default:documento.cliente.rut }}</strong></p>
          {% if documento.giro %}
            <p class="mb-1">Giro: {{ documento.giro }}</p>
          {% endif %}
          {% if documento.direccion %}
            <p class="mb-1"><i class="bi bi-geo-alt"></i> {{ documento.direccion }}</p>
          {% endif %}
          {% if documento.comuna or documento.ciudad %}
            <p class="mb-1">{{ documento.comuna }}{% if documento.ciudad %}, {{ documento.ciudad }}{% endif %}</p>
          {% endif %}
          {% if documento.cliente.correo %}
            <p class="mb-0"><i class="bi bi-envelope"></i> {{ documento.cliente.correo }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Datos del Documento - SOLO con campos existentes -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-secondary text-white">
          <i class="bi bi-receipt"></i> Detalle del Documento
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6"><p class="mb-2"><strong>Folio:</strong> {{ documento.folio }}</p></div>
            <div class="col-md-6"><p class="mb-2"><strong>Tipo:</strong> {{ documento.tipo_documento }}</p></div>
            <div class="col-md-6"><p class="mb-2"><strong>Estado:</strong> {{ documento.estado }}</p></div>
            <div class="col-md-6"><p class="mb-2"><strong>Vendedor:</strong> {{ documento.vendedor.get_full_name|default:documento.vendedor.username }}</p></div>
            <div class="col-md-6"><p class="mb-0"><strong>Emisi√≥n:</strong> {{ documento.fecha_emision|date:"d/m/Y H:i" }}</p></div>
            <div class="col-md-6"><p class="mb-0"><strong>Vencimiento:</strong> {% if documento.fecha_vencimiento %}{{ documento.fecha_vencimiento|date:"d/m/Y" }}{% else %}<span class="text-muted">No especificado</span>{% endif %}</p></div>
            {% if documento.medio_de_pago %}
              <div class="col-md-6 mt-2"><p class="mb-0"><strong>Medio de Pago:</strong> {{ documento.medio_de_pago }}</p></div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de productos -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white">
      <i class="bi bi-cart"></i> Productos Vendidos
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Producto</th>
              <th class="text-center">Cantidad</th>
              <th class="text-end">Precio Unitario</th>
              <th class="text-end">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for det in documento.detalles.all %}
              <tr>
                <td>{{ det.producto.nombre }}</td>
                <td class="text-center">{{ det.cantidad }}</td>
                <td class="text-end">${{ det.precio_unitario_venta|floatformat:0 }}</td>
                <td class="text-end"><strong>${{ det.subtotal|floatformat:0 }}</strong></td>
              </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <td colspan="3" class="text-end"><strong>Neto:</strong></td>
              <td class="text-end"><strong>${{ documento.neto|floatformat:0 }}</strong></td>
            </tr>
            <tr>
              <td colspan="3" class="text-end"><strong>IVA (19%):</strong></td>
              <td class="text-end"><strong>${{ documento.iva|floatformat:0 }}</strong></td>
            </tr>
            <tr class="table-primary">
              <td colspan="3" class="text-end"><strong>TOTAL:</strong></td>
              <td class="text-end"><strong class="fs-5 text-success">${{ documento.total|floatformat:0 }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
@media print { .btn, .card-header { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
</style>
{% endblock %}